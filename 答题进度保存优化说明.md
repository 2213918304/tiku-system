# 答题进度保存与离开确认优化说明

## 优化内容

本次优化针对答题页面（`practice/Session.vue`）进行了以下两大改进：

### 1. 答题进度持久化

#### 问题描述
之前在答题过程中，如果用户刷新页面，所有答题进度都会丢失，需要重新开始。

#### 解决方案

**1.1 自动保存机制**
- 添加了自动保存功能，每30秒自动保存一次进度
- 在用户答案改变时标记为"有未保存更改"
- 在以下时机自动保存进度：
  - 切换题目时
  - 提交答案后
  - 组件卸载时
  - 页面刷新/关闭时

**1.2 进度恢复机制**
- 在加载答题会话时，自动检查是否有之前保存的进度
- 如果存在，自动恢复以下内容：
  - 当前答题位置（第几题）
  - 所有已作答的答案
  - 每题的答题状态（已答/正确/错误）
  - 剩余答题时间
- 恢复成功后显示提示消息

**1.3 数据存储结构**
```javascript
{
  currentIndex: number,        // 当前题目索引
  userAnswers: Array,          // 用户所有答案
  answerStatus: Object,        // 答题状态
  remainingSeconds: number,    // 剩余秒数
  savedAt: string             // 保存时间戳
}
```

存储位置：`sessionStorage`  
存储键：`practice_progress_${sessionId}`

---

### 2. 离开页面确认提示

#### 问题描述
用户在答题过程中，如果不小心点击了其他菜单或按钮，会直接离开答题页面，导致正在作答的题目丢失（虽然已答题目会保存）。

#### 解决方案

**2.1 路由守卫**
- 使用 Vue Router 的 `onBeforeRouteLeave` 守卫
- 在用户尝试离开页面时弹出确认对话框
- 确认对话框内容：
  - 标题："确认离开"
  - 消息："你确定要离开答题页面吗？当前进度已自动保存，下次可以继续作答。"
  - 按钮："继续答题" / "离开"

**2.2 页面刷新/关闭拦截**
- 监听浏览器 `beforeunload` 事件
- 在页面刷新或关闭前：
  - 自动保存进度
  - 显示浏览器原生确认对话框
  - 提示："你确定要离开吗？当前进度已自动保存。"

**2.3 智能判断**
以下情况不会触发确认提示：
- 用户已经正常退出练习（点击"退出练习"按钮）
- 用户已经完成练习并提交
- 用户没有未保存的更改
- 正常跳转到结果页面

---

## 技术实现细节

### 核心变量
```typescript
const hasUnsavedChanges = ref(false)     // 是否有未保存的更改
const isExiting = ref(false)             // 是否正在正常退出
let autoSaveInterval: any = null          // 自动保存定时器
```

### 路由守卫逻辑

**`onBeforeRouteLeave()`** - 离开页面前的确认
```typescript
onBeforeRouteLeave((_to, _from, next) => {
  // 如果是正常退出（点击退出按钮或完成练习），直接放行
  if (isExiting.value) {
    next()
    return
  }
  
  // 其他所有情况都需要确认
  ElMessageBox.confirm(
    '你确定要离开答题页面吗？当前进度已自动保存，下次可以继续作答。',
    '确认离开',
    {
      confirmButtonText: '离开',
      cancelButtonText: '继续答题',
      type: 'warning'
    }
  ).then(() => {
    saveProgress()
    isExiting.value = true
    next()
  }).catch(() => {
    next(false)
  })
})
```

### 核心函数

**`saveProgress()`** - 保存进度
```typescript
const saveProgress = () => {
  const sessionId = route.query.sessionId as string
  if (sessionId) {
    const progressData = {
      currentIndex: currentIndex.value,
      userAnswers: Array.from(userAnswers.value.entries()),
      answerStatus: answerStatus.value,
      remainingSeconds: remainingSeconds.value,
      savedAt: new Date().toISOString()
    }
    sessionStorage.setItem(`practice_progress_${sessionId}`, JSON.stringify(progressData))
    hasUnsavedChanges.value = false
  }
}
```

**`startAutoSave()`** - 开始自动保存
```typescript
const startAutoSave = () => {
  autoSaveInterval = setInterval(() => {
    if (hasUnsavedChanges.value) {
      saveProgress()
      console.log('自动保存进度...')
    }
  }, 30000) // 30秒
}
```

**恢复进度逻辑**（在 `loadPracticeSession` 中）
```typescript
const savedProgress = sessionStorage.getItem(`practice_progress_${sessionId}`)
if (savedProgress) {
  const progress = JSON.parse(savedProgress)
  currentIndex.value = progress.currentIndex
  userAnswers.value = new Map(progress.userAnswers)
  answerStatus.value = progress.answerStatus
  remainingSeconds.value = progress.remainingSeconds
  ElMessage.success('已恢复上次答题进度')
}
```

---

## 用户体验改进

### 改进前
❌ 刷新页面后进度丢失，需要重新答题  
❌ 误点其他菜单直接离开，正在作答的题目丢失  
❌ 无任何进度保存提示

### 改进后
✅ 刷新页面后自动恢复到之前的答题位置  
✅ 自动恢复所有已作答的答案和状态  
✅ 离开页面前有确认提示，防止误操作  
✅ 每30秒自动保存，无需手动操作  
✅ 页面关闭前自动保存并提示  
✅ 明确的进度恢复成功提示

---

## 注意事项

1. **数据存储位置**：使用 `sessionStorage`，关闭浏览器标签后数据会清除
2. **自动保存频率**：30秒，可根据需要调整
3. **进度数据清理**：完成练习提交后会自动清除进度数据
4. **路由守卫**：仅在有未保存更改时触发确认提示
5. **浏览器兼容性**：`beforeunload` 事件在现代浏览器中都支持

---

## 后续可优化项

1. 可以考虑将进度同步到后端，实现跨设备恢复
2. 可以添加"保存草稿"功能，让用户手动保存
3. 可以记录每题的答题时长统计
4. 可以添加离线答题支持（使用 IndexedDB）

---

## 修改文件

- `tiku-frontend/src/views/practice/Session.vue`

## 测试建议

1. 测试答题过程中刷新页面，验证进度是否恢复
2. 测试答到一半时点击左侧菜单，验证确认提示是否弹出
3. 测试自动保存功能，30秒后检查 sessionStorage
4. 测试完成练习后，进度数据是否被清除
5. 测试退出练习按钮，验证正常退出流程

